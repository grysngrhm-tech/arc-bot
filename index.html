<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Architectural Review Console | Discovery West</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Discovery West architectural guidelines assistant. Get instant answers about CC&Rs, design guidelines, and community rules with citations from official documents.">
  <meta name="theme-color" content="#c96f3c">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ARC Bot">
  <meta name="format-detection" content="telephone=no">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Favicons and App Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16.png">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="assets/icons/icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-180.png">
  
  <!-- iOS Splash Screens (basic) -->
  <link rel="apple-touch-startup-image" href="assets/icons/icon-512.png">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== CSS RESET & BASE ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ===== CSS VARIABLES - DISCOVERY WEST DARK THEME ===== */
    :root {
      --bg-primary: #2d2d2d;
      --bg-secondary: #3d3d3d;
      --bg-chat: #2d2d2d;
      --bg-card: #454545;
      --bg-input: #525252;
      --bg-user-msg: linear-gradient(135deg, #c96f3c 0%, #b85a2a 100%);
      --bg-bot-msg: #3d3d3d;
      --bg-source: #454545;
      --bg-source-expanded: #525252;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --text-muted: #888888;
      --text-on-accent: #ffffff;
      --accent: #c96f3c;
      --accent-hover: #d4844f;
      --accent-subtle: rgba(201, 111, 60, 0.15);
      --border: #555555;
      --border-focus: #c96f3c;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3);
      --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.4);
      --confidence-high: #4ade80;
      --confidence-medium: #fbbf24;
      --confidence-low: #f87171;
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-pill: 25px;
      --transition: 200ms ease;
    }

    /* ===== LIGHT THEME OVERRIDE ===== */
    [data-theme="light"] {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --bg-chat: #f5f5f5;
      --bg-card: #ffffff;
      --bg-input: #ffffff;
      --bg-user-msg: linear-gradient(135deg, #c96f3c 0%, #b85a2a 100%);
      --bg-bot-msg: #ffffff;
      --bg-source: #f0f0f0;
      --bg-source-expanded: #e5e5e5;
      --text-primary: #1a1a1a;
      --text-secondary: #4a4a4a;
      --text-muted: #777777;
      --text-on-accent: #ffffff;
      --accent: #c96f3c;
      --accent-hover: #b85a2a;
      --accent-subtle: rgba(201, 111, 60, 0.1);
      --border: #d5d5d5;
      --border-focus: #c96f3c;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --confidence-high: #16a34a;
      --confidence-medium: #ca8a04;
      --confidence-low: #dc2626;
    }

    /* ===== TYPOGRAPHY ===== */
    body {
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== LAYOUT ===== */
    .app-container {
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-secondary);
      box-shadow: var(--shadow-lg);
    }

    @media (min-width: 768px) {
      .app-container {
        margin: 1rem auto;
        height: calc(100vh - 2rem);
        border-radius: var(--radius-xl);
        overflow: hidden;
      }
    }

    /* ===== HEADER ===== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      cursor: pointer;
      border-radius: 8px;
      padding: 0.25rem 0.5rem;
      margin: -0.25rem -0.5rem;
      transition: background 0.2s ease;
    }
    
    .header-brand:hover {
      background: var(--bg-card);
    }
    
    .header-brand:active {
      background: var(--bg-input);
    }

    .header-icon {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
    }

    .header-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .header-titles {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .header h1 {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
      line-height: 1.2;
    }

    .header-subtitle {
      font-size: 0.6875rem;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .theme-toggle {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      padding: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      background: var(--accent-subtle);
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    .theme-toggle:hover svg {
      color: var(--accent);
    }

    /* Dark theme is default, so show moon by default */
    .theme-toggle .sun { display: block; }
    .theme-toggle .moon { display: none; }
    [data-theme="light"] .theme-toggle .sun { display: none; }
    [data-theme="light"] .theme-toggle .moon { display: block; }

    /* ===== CHAT AREA ===== */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: var(--bg-chat);
    }

    /* ===== MESSAGES ===== */
    .message {
      max-width: 85%;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-user {
      align-self: flex-end;
    }

    .message-bot {
      align-self: flex-start;
    }

    .message-content {
      padding: 0.875rem 1rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .message-user .message-content {
      background: var(--bg-user-msg);
      color: var(--text-on-accent);
      border-bottom-right-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
    }

    .message-bot .message-content {
      background: var(--bg-bot-msg);
      color: var(--text-primary);
      border-bottom-left-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    .message-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .message-sender {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--accent);
    }

    /* ===== CONFIDENCE BADGE ===== */
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      background: var(--bg-source);
    }

    .confidence-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .confidence-high .confidence-dot { background: var(--confidence-high); }
    .confidence-medium .confidence-dot { background: var(--confidence-medium); }
    .confidence-low .confidence-dot { background: var(--confidence-low); }

    .confidence-high { color: var(--confidence-high); }
    .confidence-medium { color: var(--confidence-medium); }
    .confidence-low { color: var(--confidence-low); }

    /* ===== CONFIDENCE BADGE - INTERACTIVE ===== */
    .confidence-badge {
      cursor: pointer;
      position: relative;
      transition: var(--transition);
    }

    .confidence-badge:hover {
      opacity: 0.8;
    }

    .confidence-tooltip {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 280px;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      font-size: 0.8125rem;
      font-weight: 400;
      color: var(--text-secondary);
      line-height: 1.5;
      z-index: 100;
      display: none;
      animation: tooltipFadeIn 0.15s ease;
    }

    .confidence-tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      right: 16px;
      width: 10px;
      height: 10px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      border-top: 1px solid var(--border);
      transform: rotate(45deg);
    }

    .confidence-badge.tooltip-open .confidence-tooltip {
      display: block;
    }

    @keyframes tooltipFadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== MESSAGE HEADER ACTIONS ===== */
    .message-header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .message-header-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .copy-btn {
      background: transparent;
      border: none;
      padding: 0.25rem;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .copy-btn:hover {
      color: var(--text-secondary);
      background: var(--bg-source);
    }

    .copy-btn svg {
      width: 14px;
      height: 14px;
    }

    .copy-btn.copied {
      color: var(--confidence-high);
    }

    /* ===== ANSWER SECTION ===== */
    .answer-section {
      margin-bottom: 0.75rem;
    }

    .answer-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.375rem;
    }

    .answer-text {
      line-height: 1.7;
      color: var(--text-primary);
    }

    .answer-text p {
      margin-bottom: 0.5rem;
    }

    .answer-text p:last-child {
      margin-bottom: 0;
    }

    /* ===== SOURCES & REQUIREMENTS SECTION ===== */
    .sources-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .sources-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ===== SOURCE ITEM WITH REQUIREMENTS ===== */
    .source-item {
      background: var(--bg-source);
      border-radius: var(--radius-md);
      margin-bottom: 0.625rem;
      overflow: hidden;
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
    }

    .source-item:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-sm);
    }

    .source-item:last-child {
      margin-bottom: 0;
    }

    .source-header {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.75rem;
    }

    .source-info {
      flex: 1;
      min-width: 0;
    }

    .source-path {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.125rem;
      line-height: 1.4;
    }

    .source-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* ===== AUTHORITY BADGE ===== */
    .authority-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.625rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .authority-binding {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    .authority-guidance {
      background: rgba(136, 136, 136, 0.15);
      color: var(--text-muted);
    }

    /* ===== SOURCE REQUIREMENTS ===== */
    .source-requirements {
      padding: 0.5rem 0.75rem 0.75rem 1rem;
      border-left: 3px solid var(--accent);
      margin: 0 0.75rem 0.5rem 0.75rem;
      background: var(--accent-subtle);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }

    .requirements-label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .source-requirements ul {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .source-requirements li {
      position: relative;
      padding-left: 1rem;
      margin-bottom: 0.375rem;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .source-requirements li:last-child {
      margin-bottom: 0;
    }

    .source-requirements li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0.5rem;
      width: 5px;
      height: 5px;
      background: var(--accent);
      border-radius: 50%;
    }

    /* ===== VIEW SOURCE LINK ===== */
    .view-source-link {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      margin: 0 0.75rem 0.75rem 0.75rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.6875rem;
      font-family: inherit;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      font-weight: 500;
    }

    .view-source-link:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: var(--accent-subtle);
    }

    .view-source-link svg {
      width: 12px;
      height: 12px;
    }

    /* ===== SOURCE MODAL ===== */
    .source-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      animation: fadeIn 0.15s ease;
    }

    .source-modal-overlay.active {
      display: flex;
    }

    .source-modal {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      max-width: 700px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.2s ease;
    }

    .source-modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .source-modal-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .source-modal-close {
      background: none;
      border: none;
      padding: 0.25rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: var(--transition);
      flex-shrink: 0;
    }

    .source-modal-close:hover {
      color: var(--text-primary);
    }

    .source-modal-close svg {
      width: 20px;
      height: 20px;
    }

    .source-modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      font-size: 0.875rem;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 200px; }
    }

    /* ===== MESSAGE BODY ===== */
    .message-body {
      line-height: 1.7;
    }

    .message-body p {
      margin-bottom: 0.75rem;
    }

    .message-body p:last-child {
      margin-bottom: 0;
    }

    .message-body strong {
      font-weight: 600;
    }

    .message-body ul, .message-body ol {
      margin: 0.5rem 0 0.75rem 1.25rem;
    }

    .message-body li {
      margin-bottom: 0.25rem;
    }


    @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 200px; }
    }

    /* ===== WELCOME PANEL ===== */
    .welcome-panel {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      animation: welcomeFadeIn 0.5s ease;
    }

    @keyframes welcomeFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Hero Section */
    .welcome-hero {
      text-align: center;
      margin-bottom: 2rem;
      animation: welcomeFadeIn 0.5s ease;
    }

    .welcome-icon {
      width: 72px;
      height: 86px;
      margin: 0 auto 0.75rem;
    }

    .welcome-logo {
      width: 72px;
      height: 86px;
      object-fit: contain;
    }

    .welcome-hero h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      letter-spacing: -0.01em;
    }

    .welcome-tagline {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0;
      max-width: 480px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Two-Column Content */
    .welcome-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      animation: welcomeFadeIn 0.5s ease 0.15s both;
    }

    @media (max-width: 640px) {
      .welcome-content {
        grid-template-columns: 1fr;
      }
    }

    .welcome-knowledge,
    .welcome-getstarted {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
    }

    .welcome-knowledge h3,
    .welcome-getstarted h3 {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .section-intro {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin: 0 0 1rem 0;
      line-height: 1.5;
    }

    .badge-inline {
      display: inline-block;
      font-size: 0.625rem;
      font-weight: 600;
      padding: 0.125rem 0.375rem;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .badge-inline.binding {
      background: rgba(74, 222, 128, 0.15);
      color: var(--confidence-high);
    }

    /* ===== DOCUMENT LINKS ===== */
    .welcome-knowledge .document-links {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    @media (max-width: 480px) {
      .welcome-knowledge .document-links {
        grid-template-columns: 1fr;
      }
    }

    .doc-link {
      display: flex;
      flex-direction: column;
      padding: 0.75rem;
      background: var(--bg-source);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .doc-link:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .doc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.375rem;
    }

    .doc-link .doc-icon {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .doc-badge {
      font-size: 0.5625rem;
      font-weight: 600;
      padding: 0.125rem 0.375rem;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .doc-badge.binding {
      background: rgba(74, 222, 128, 0.15);
      color: var(--confidence-high);
    }

    .doc-badge.guidance {
      background: rgba(251, 191, 36, 0.15);
      color: var(--confidence-medium);
    }

    .doc-link .doc-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.125rem;
    }

    .doc-link .doc-desc {
      font-size: 0.625rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    /* ===== GET STARTED / QUESTION CHIPS ===== */
    .question-chips {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .question-chip {
      background: var(--bg-source);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.625rem 0.875rem;
      font-size: 0.75rem;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      line-height: 1.4;
    }

    .question-chip:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--text-on-accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    /* Staggered animations for welcome panel elements */
    .doc-link {
      animation: welcomeFadeIn 0.4s ease both;
    }

    .doc-link:nth-child(1) { animation-delay: 0.2s; }
    .doc-link:nth-child(2) { animation-delay: 0.25s; }
    .doc-link:nth-child(3) { animation-delay: 0.3s; }
    .doc-link:nth-child(4) { animation-delay: 0.35s; }

    .question-chip {
      animation: welcomeFadeIn 0.3s ease both;
    }

    .question-chip:nth-child(1) { animation-delay: 0.25s; }
    .question-chip:nth-child(2) { animation-delay: 0.3s; }
    .question-chip:nth-child(3) { animation-delay: 0.35s; }
    .question-chip:nth-child(4) { animation-delay: 0.4s; }

    @media (max-width: 640px) {
      .welcome-panel {
        padding: 1.5rem 1rem;
      }
    }

    /* ===== TYPING INDICATOR ===== */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--bg-bot-msg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      border-bottom-left-radius: var(--radius-sm);
      width: fit-content;
      min-width: 200px;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typingBounce {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    .typing-status {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .typing-message {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .typing-time {
      font-size: 0.6875rem;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .typing-retry {
      font-size: 0.75rem;
      color: var(--confidence-medium);
      font-weight: 500;
    }

    /* ===== INPUT AREA ===== */
    .input-area {
      padding: 1rem 1.5rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .input-container {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }

    .voice-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
    }

    .voice-btn:hover {
      border-color: var(--accent);
      background: var(--accent-subtle);
    }

    .voice-btn svg {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    .voice-btn:hover svg {
      color: var(--accent);
    }
    
    .voice-btn.listening {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      animation: voice-pulse 1.5s ease-in-out infinite;
    }
    
    .voice-btn.listening svg {
      color: #ef4444;
    }
    
    @keyframes voice-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .message-input {
      width: 100%;
      padding: 0.75rem 1.25rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 0.9375rem;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: all 0.2s ease;
      min-height: 44px;
      max-height: 120px;
    }

    .message-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    .message-input::placeholder {
      color: var(--text-muted);
    }

    .send-btn {
      background: var(--accent);
      border: none;
      border-radius: var(--radius-pill);
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .send-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-btn svg {
      width: 20px;
      height: 20px;
      color: var(--text-on-accent);
    }

    /* ===== ERROR STATE ===== */
    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 0.875rem 1rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .error-message-content {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .error-message-content svg {
      flex-shrink: 0;
      margin-top: 0.125rem;
    }

    .error-message-text {
      flex: 1;
    }

    .error-message-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .error-message-detail {
      font-size: 0.8125rem;
      opacity: 0.9;
    }

    .error-actions {
      display: flex;
      gap: 0.5rem;
      margin-left: 1.5rem;
    }

    .error-retry-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      background: transparent;
      border: 1px solid currentColor;
      border-radius: var(--radius-pill);
      color: inherit;
      font-size: 0.75rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .error-retry-btn:hover {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .error-retry-btn svg {
      width: 12px;
      height: 12px;
    }

    [data-theme="dark"] .error-message,
    :root:not([data-theme="light"]) .error-message {
      background: #450a0a;
      border-color: #7f1d1d;
      color: #fca5a5;
    }

    [data-theme="dark"] .error-retry-btn:hover,
    :root:not([data-theme="light"]) .error-retry-btn:hover {
      background: #fca5a5;
      border-color: #fca5a5;
      color: #450a0a;
    }

    /* ===== CANCEL BUTTON STATE ===== */
    .send-btn.cancel-mode {
      background: var(--confidence-low);
    }

    .send-btn.cancel-mode:hover:not(:disabled) {
      background: #ef4444;
    }

    /* ===== SCROLLBAR ===== */
    .chat-area::-webkit-scrollbar,
    .source-modal-body::-webkit-scrollbar {
      width: 6px;
    }

    .chat-area::-webkit-scrollbar-track,
    .source-modal-body::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-area::-webkit-scrollbar-thumb,
    .source-modal-body::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .chat-area::-webkit-scrollbar-thumb:hover,
    .source-modal-body::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ===== WELCOME META ===== */
    .welcome-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 1rem;
      line-height: 1.5;
    }

    .welcome-meta a {
      color: var(--accent);
      text-decoration: none;
    }

    .welcome-meta a:hover {
      text-decoration: underline;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header {
        padding: 0.875rem 1rem;
      }

      .header h1 {
        font-size: 0.9375rem;
      }

      .header-icon {
        width: 32px;
        height: 32px;
      }

      .header-subtitle {
        font-size: 0.6rem;
      }
    }

    @media (max-width: 640px) {
      .header h1 {
        font-size: 0.875rem;
      }

      .header-subtitle {
        display: none;
      }

      .header-brand {
        gap: 0.625rem;
      }

      .chat-area {
        padding: 1rem;
      }

      .message {
        max-width: 92%;
      }

      .input-area {
        padding: 0.875rem 1rem;
      }

      .voice-btn span {
        display: none;
      }

      .app-footer {
        font-size: 0.5625rem;
      }
    }

    /* ===== PWA: OFFLINE BANNER ===== */
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10000;
      background: var(--color-error, #dc2626);
      color: white;
      text-align: center;
      padding: 0.5rem 1rem;
      padding-top: calc(0.5rem + env(safe-area-inset-top));
      font-size: 0.8125rem;
      font-weight: 500;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }
    
    .offline-banner.visible {
      transform: translateY(0);
    }
    
    .offline-banner.online {
      background: var(--color-success, #16a34a);
    }

    /* ===== PWA: INSTALL BANNER ===== */
    .install-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .install-banner.visible {
      transform: translateY(0);
    }
    
    .install-banner-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }
    
    .install-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      flex-shrink: 0;
    }
    
    .install-text {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-width: 0;
    }
    
    .install-text strong {
      font-size: 0.9375rem;
      color: var(--text-primary);
    }
    
    .install-text span {
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .install-text svg {
      flex-shrink: 0;
    }
    
    .install-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    
    .install-btn {
      background: var(--accent-orange);
      color: white;
      border: none;
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      min-width: 44px;
      transition: background 0.2s ease;
    }
    
    .install-btn:hover {
      background: var(--accent-orange-hover, #b85a2a);
    }
    
    .install-dismiss {
      background: transparent;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      min-height: 44px;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background 0.2s ease;
    }
    
    .install-dismiss:hover {
      background: var(--bg-card);
    }

    /* ===== MOBILE: SAFE AREA HANDLING ===== */
    @supports (padding: env(safe-area-inset-top)) {
      .header {
        padding-top: calc(0.875rem + env(safe-area-inset-top));
      }
      
      .input-area {
        padding-bottom: calc(0.875rem + env(safe-area-inset-bottom));
      }
      
      .app-container {
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }

    /* ===== MOBILE: TOUCH TARGETS ===== */
    @media (max-width: 768px) {
      /* Ensure minimum 44x44px touch targets */
      .question-chip {
        min-height: 44px;
        padding: 0.75rem 1rem;
      }
      
      .copy-answer-btn {
        min-height: 44px;
        min-width: 44px;
        padding: 0.75rem;
      }
      
      .source-toggle {
        min-height: 44px;
        padding: 0.75rem 1rem;
      }
      
      .source-item {
        min-height: 44px;
        padding: 0.75rem;
      }
      
      .theme-toggle {
        min-height: 44px;
        min-width: 44px;
        padding: 0.625rem;
      }
      
      .voice-btn {
        min-height: 44px;
        min-width: 44px;
      }
      
      .confidence-badge {
        min-height: 36px;
        padding: 0.5rem 0.75rem;
      }
      
      /* Larger tap areas for error retry */
      .error-retry-btn {
        min-height: 44px;
        padding: 0.625rem 1rem;
      }
    }

    /* ===== MOBILE: INPUT OPTIMIZATION ===== */
    @media (max-width: 768px) {
      /* Prevent iOS zoom on input focus - must be 16px+ */
      .message-input {
        font-size: 16px !important;
      }
      
      /* Better input area for mobile */
      .input-area {
        gap: 0.5rem;
      }
      
      .message-input {
        padding: 0.875rem 1rem;
        min-height: 48px;
      }
      
      .send-btn {
        min-height: 48px;
        min-width: 48px;
      }
    }

    /* ===== MOBILE: VIEWPORT FIXES ===== */
    html {
      /* Prevent overscroll bounce */
      overscroll-behavior: none;
      /* Smooth scrolling */
      scroll-behavior: smooth;
    }
    
    body {
      /* Prevent pull-to-refresh on mobile */
      overscroll-behavior-y: contain;
      /* Enable momentum scrolling on iOS */
      -webkit-overflow-scrolling: touch;
    }
    
    .chat-area {
      /* Prevent overscroll on chat area */
      overscroll-behavior: contain;
    }

    /* ===== MOBILE: STANDALONE MODE ADJUSTMENTS ===== */
    @media (display-mode: standalone) {
      /* When running as installed PWA */
      .header {
        padding-top: calc(1rem + env(safe-area-inset-top));
      }
      
      /* Hide footer in standalone mode for more space */
      .app-footer {
        display: none;
      }
    }

    /* ===== MOBILE: LANDSCAPE ORIENTATION ===== */
    @media (max-height: 500px) and (orientation: landscape) {
      .welcome-panel {
        padding: 1rem;
      }
      
      .welcome-hero {
        padding: 0.75rem 0;
      }
      
      .welcome-hero h2 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }
      
      .welcome-tagline {
        display: none;
      }
      
      .welcome-content {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
    }

    /* ===== VOICE MODE OVERLAY ===== */
    .voice-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      z-index: 2000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      padding-top: calc(2rem + env(safe-area-inset-top));
      padding-bottom: calc(2rem + env(safe-area-inset-bottom));
    }
    
    .voice-overlay.active {
      display: flex;
      animation: fadeIn 0.2s ease;
    }
    
    .voice-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      top: calc(1rem + env(safe-area-inset-top));
      background: var(--bg-card);
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    
    .voice-close:hover {
      background: var(--bg-input);
      color: var(--text-primary);
    }
    
    .voice-close svg {
      width: 24px;
      height: 24px;
    }
    
    .voice-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    /* Voice Orb Animation */
    .voice-orb-container {
      position: relative;
      width: 160px;
      height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .voice-orb {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-orange) 0%, #e85d04 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .voice-orb svg {
      width: 48px;
      height: 48px;
      color: white;
    }
    
    .voice-orb-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      border: 2px solid var(--accent-orange);
      opacity: 0;
      z-index: 1;
    }
    
    /* Idle state - subtle pulse */
    .voice-overlay[data-state="idle"] .voice-orb {
      animation: orb-idle 3s ease-in-out infinite;
    }
    
    @keyframes orb-idle {
      0%, 100% { transform: scale(1); box-shadow: 0 0 40px rgba(201, 111, 60, 0.3); }
      50% { transform: scale(1.02); box-shadow: 0 0 60px rgba(201, 111, 60, 0.4); }
    }
    
    /* Listening state - reactive rings */
    .voice-overlay[data-state="listening"] .voice-orb {
      animation: none;
      box-shadow: 0 0 60px rgba(201, 111, 60, 0.5);
    }
    
    .voice-overlay[data-state="listening"] .voice-orb-ring {
      animation: ring-expand 1.5s ease-out infinite;
    }
    
    .voice-overlay[data-state="listening"] .voice-orb-ring:nth-child(2) {
      animation-delay: 0.5s;
    }
    
    .voice-overlay[data-state="listening"] .voice-orb-ring:nth-child(3) {
      animation-delay: 1s;
    }
    
    @keyframes ring-expand {
      0% { width: 120px; height: 120px; opacity: 0.6; }
      100% { width: 200px; height: 200px; opacity: 0; }
    }
    
    /* Processing state - spinning glow */
    .voice-overlay[data-state="processing"] .voice-orb {
      animation: orb-processing 1s ease-in-out infinite;
    }
    
    @keyframes orb-processing {
      0%, 100% { transform: scale(0.95); box-shadow: 0 0 40px rgba(201, 111, 60, 0.4); }
      50% { transform: scale(1.05); box-shadow: 0 0 80px rgba(201, 111, 60, 0.6); }
    }
    
    /* Speaking state - wave effect */
    .voice-overlay[data-state="speaking"] .voice-orb {
      animation: orb-speaking 0.5s ease-in-out infinite;
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    }
    
    @keyframes orb-speaking {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }
    
    /* Transcript display */
    .voice-transcript {
      min-height: 80px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 100%;
    }
    
    .voice-transcript-user {
      font-size: 1.125rem;
      color: var(--text-primary);
      font-weight: 500;
      line-height: 1.5;
      min-height: 1.5em;
    }
    
    .voice-transcript-bot {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    .voice-status {
      font-size: 0.875rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .voice-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-orange);
    }
    
    .voice-overlay[data-state="listening"] .voice-status-dot {
      background: #ef4444;
      animation: status-pulse 1s ease-in-out infinite;
    }
    
    .voice-overlay[data-state="processing"] .voice-status-dot {
      background: #f59e0b;
      animation: status-pulse 0.5s ease-in-out infinite;
    }
    
    .voice-overlay[data-state="speaking"] .voice-status-dot {
      background: #16a34a;
    }
    
    @keyframes status-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* Voice action buttons */
    .voice-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .voice-action-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 48px;
    }
    
    .voice-action-btn:hover {
      background: var(--bg-input);
      border-color: var(--accent-orange);
    }
    
    .voice-action-btn svg {
      width: 18px;
      height: 18px;
    }
    
    .voice-action-btn.primary {
      background: var(--accent-orange);
      border-color: var(--accent-orange);
      color: white;
    }
    
    .voice-action-btn.primary:hover {
      background: var(--accent-orange-hover, #b85a2a);
    }
    
    .voice-action-btn.stop {
      background: #ef4444;
      border-color: #ef4444;
      color: white;
    }
    
    .voice-action-btn.stop:hover {
      background: #dc2626;
    }
    
    /* Voice error state */
    .voice-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 1rem;
      color: #ef4444;
      font-size: 0.875rem;
      display: none;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }
    
    .voice-error.visible {
      display: flex;
    }
    
    .voice-error svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    
    /* Mobile adjustments for voice overlay */
    @media (max-width: 480px) {
      .voice-overlay {
        padding: 1.5rem;
      }
      
      .voice-orb-container {
        width: 140px;
        height: 140px;
      }
      
      .voice-orb {
        width: 100px;
        height: 100px;
      }
      
      .voice-orb svg {
        width: 40px;
        height: 40px;
      }
      
      @keyframes ring-expand {
        0% { width: 100px; height: 100px; opacity: 0.6; }
        100% { width: 160px; height: 160px; opacity: 0; }
      }
    }
  </style>
</head>
<body>
  <!-- PWA: Offline Banner -->
  <div class="offline-banner" id="offlineBanner">
    You're offline â€” cached content only
  </div>
  
  <!-- PWA: Install Banner -->
  <div class="install-banner" id="installBanner">
    <div class="install-banner-content">
      <img src="assets/icons/icon-72.png" alt="ARC Bot" class="install-icon">
      <div class="install-text">
        <strong>Install ARC Bot</strong>
        <span id="iosInstructions" style="display: none;">
          Tap <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> then "Add to Home Screen"
        </span>
      </div>
    </div>
    <div class="install-actions">
      <button class="install-btn" id="androidInstallBtn" onclick="promptInstall()">
        Install
      </button>
      <button class="install-dismiss" onclick="dismissInstallBanner()" aria-label="Dismiss">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-brand" onclick="startNewChat()" title="Start new conversation">
        <!-- Official Discovery West Pinecone Logo -->
        <img class="header-icon header-logo" src="assets/pinecone-logo.png" alt="Discovery West Logo">
        <div class="header-titles">
          <h1>Architectural Review Console</h1>
          <span class="header-subtitle">Discovery West Community</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
          <svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
      </div>
    </header>

    <!-- Chat Area -->
    <main class="chat-area" id="chatArea">
      <!-- Welcome panel is generated dynamically by JavaScript -->
    </main>

    <!-- Input Area -->
    <footer class="input-area">
      <div class="input-container">
        <button class="voice-btn" id="voiceBtn" onclick="openVoiceMode()" title="Voice input">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </button>
        <div class="input-wrapper">
          <textarea
            class="message-input"
            id="messageInput"
            placeholder="Ask about guidelines, requirements, or processes..."
            rows="1"
            inputmode="text"
            enterkeyhint="send"
            autocapitalize="sentences"
            autocomplete="off"
            autocorrect="on"
            spellcheck="true"
            onkeydown="handleKeyDown(event)"
            oninput="autoResize(this)"
          ></textarea>
        </div>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send message">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </footer>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const API_URL = 'https://n8n.srv1208741.hstgr.cloud/webhook/arc-chat';
    const REQUEST_TIMEOUT_MS = 45000; // 45 seconds
    const MAX_RETRIES = 3;
    const RETRY_DELAY_BASE_MS = 1000; // 1s, 2s, 4s exponential
    
    // ===== QUESTION LIBRARY =====
    // Organized by source document - 5+ questions each targeting specific nuanced details
    const questionLibrary = {
      // Design Guidelines (Guidance) - Architectural standards
      designGuidelines: [
        "What is the minimum conifer tree spacing required for wildfire mitigation?",
        "How far must garage windows be from grade to require obscured glazing?",
        "What fence height is allowed within 8 feet of an alley?",
        "What offset is required for homes with more than two garage bays?",
        "What type of fencing is required parallel to a Non-Development Easement?",
        "What is the FAR percentage if my home includes an ADU?",
        "What roofing materials are prohibited in Discovery West?",
        "What is the minimum street tree caliper at time of planting?",
        "What materials are required for fence posts in Discovery West?",
        "How close can a fence be to home siding per wildfire requirements?"
      ],
      // CC&Rs (Binding) - Covenants & restrictions
      ccrs: [
        "What is the minimum rental period allowed under the CC&Rs?",
        "How many days until an unpaid assessment becomes delinquent?",
        "Do home swap arrangements count as short-term rentals?",
        "Can the Association pursue multiple enforcement remedies simultaneously?",
        "What triggers the Association's right to impose fines on an owner?"
      ],
      // Rules & Regulations (Guidance) - Community policies
      rulesRegs: [
        "What are the parking restrictions in Discovery West?",
        "Are there restrictions on outdoor storage or equipment?",
        "What are the rules for holiday decorations?",
        "Are commercial vehicles allowed to park on residential lots?",
        "What are the quiet hours in Discovery West?"
      ],
      // City of Bend Code (Binding) - Overlay Zone regulations
      cityCode: [
        "What is the maximum building height for cottages in cluster housing?",
        "What is the height limit for buildings on Skyliners Road?",
        "What is the maximum building height for mews houses?",
        "How is building height measured in Discovery West?",
        "What are the setback requirements for R-1 small lots?",
        "What is the maximum lot coverage for large R-3 lots?"
      ]
    };

    // Get one random question from each document category
    function getRandomQuestions() {
      return [
        questionLibrary.designGuidelines[Math.floor(Math.random() * questionLibrary.designGuidelines.length)],
        questionLibrary.ccrs[Math.floor(Math.random() * questionLibrary.ccrs.length)],
        questionLibrary.rulesRegs[Math.floor(Math.random() * questionLibrary.rulesRegs.length)],
        questionLibrary.cityCode[Math.floor(Math.random() * questionLibrary.cityCode.length)]
      ];
    }

    // Generate question chips HTML
    function generateQuestionChipsHTML() {
      const questions = getRandomQuestions();
      return questions.map(q => 
        `<button class="question-chip" onclick="askSuggestedQuestion(this)">${q}</button>`
      ).join('\n              ');
    }
    
    // ===== STATE =====
    let isLoading = false;
    let messages = [];
    let currentAbortController = null;
    let typingStartTime = null;
    let typingIntervalId = null;
    let lastMessageForRetry = null;
    let wasCancelled = false;

    // ===== SESSION MANAGEMENT =====
    function getSessionId() {
      let sessionId = sessionStorage.getItem('arc_session_id');
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
        sessionStorage.setItem('arc_session_id', sessionId);
      }
      return sessionId;
    }

    // ===== WELCOME PANEL (Single Source of Truth) =====
    function generateWelcomePanel() {
      const questionChipsHTML = generateQuestionChipsHTML();
      return `
        <div class="welcome-panel" id="welcomePanel">
          <!-- Hero Section -->
          <div class="welcome-hero">
            <img class="welcome-icon welcome-logo" src="assets/pinecone-logo.png" alt="Discovery West Logo">
            <h2>Welcome to ARC Bot</h2>
            <p class="welcome-tagline">Your AI assistant for Discovery West. Ask about architectural guidelines, CC&Rs, community rules, or City of Bend regulations â€” get answers with direct citations from official documents.</p>
            <p class="welcome-meta">ARC Bot provides information only â€” it does not issue approvals or legal advice. Powered by <a href="https://discoverywestbend.com/" target="_blank" rel="noopener">Discovery West</a> Â· <a href="https://github.com/grysngrhm-tech/arc-bot" target="_blank" rel="noopener">GitHub</a> Â· v1.8</p>
          </div>
          
          <!-- Two-Column Content Area -->
          <div class="welcome-content">
            <!-- Knowledge Base Panel -->
            <div class="welcome-knowledge">
              <h3>Knowledge Base</h3>
              <p class="section-intro">Answers cite these official sources. Documents marked <span class="badge-inline binding">Binding</span> carry legal weight.</p>
              <div class="document-links">
                <a href="https://discoverywestbend.com/wp-content/uploads/2025/02/250130-DW-ARC-Guidelines-in-thier-entireity-2.18.25.pdf" target="_blank" rel="noopener" class="doc-link">
                  <div class="doc-header">
                    <svg class="doc-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span class="doc-badge guidance">ARC Guidance</span>
                  </div>
                  <span class="doc-name">Design Guidelines</span>
                  <span class="doc-desc">Architectural standards</span>
                </a>
                <a href="https://discoverywestbend.com/wp-content/uploads/2020/02/Discovery-West-CCRs-Recorded.pdf" target="_blank" rel="noopener" class="doc-link">
                  <div class="doc-header">
                    <svg class="doc-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span class="doc-badge binding">Binding</span>
                  </div>
                  <span class="doc-name">CC&Rs</span>
                  <span class="doc-desc">Covenants & restrictions</span>
                </a>
                <a href="https://discoverywestbend.com/wp-content/uploads/2022/06/Rules-and-Regulations.pdf" target="_blank" rel="noopener" class="doc-link">
                  <div class="doc-header">
                    <svg class="doc-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span class="doc-badge guidance">DWOA Guidance</span>
                  </div>
                  <span class="doc-name">Rules & Regulations</span>
                  <span class="doc-desc">Community policies</span>
                </a>
                <a href="https://bend.municipal.codes/BDC/2.7_ArtXIX" target="_blank" rel="noopener" class="doc-link">
                  <div class="doc-header">
                    <svg class="doc-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="3" y1="9" x2="21" y2="9"></line>
                      <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    <span class="doc-badge binding">Binding</span>
                  </div>
                  <span class="doc-name">City of Bend Code</span>
                  <span class="doc-desc">Overlay Zone regulations</span>
                </a>
              </div>
            </div>
            
            <!-- Get Started Panel -->
            <div class="welcome-getstarted">
              <h3>Get Started</h3>
              <p class="section-intro">Select a question or type your own below</p>
              <div class="question-chips" id="questionChips">
                ${questionChipsHTML}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function startNewChat() {
      // Cancel any pending request
      if (currentAbortController) {
        wasCancelled = true;
        currentAbortController.abort();
        currentAbortController = null;
      }
      
      // Clear timers
      if (typingIntervalId) {
        clearInterval(typingIntervalId);
        typingIntervalId = null;
      }
      
      // Generate new session
      const newSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
      sessionStorage.setItem('arc_session_id', newSessionId);
      
      // Clear messages and state
      messages = [];
      isLoading = false;
      lastMessageForRetry = null;
      
      // Reset UI with welcome panel (using shared function)
      const chatArea = document.getElementById('chatArea');
      chatArea.innerHTML = generateWelcomePanel();
      
      // Reset send button state
      resetSendButton();
      
      // Focus input
      document.getElementById('messageInput').focus();
    }

    // ===== SUGGESTED QUESTIONS =====
    function askSuggestedQuestion(button) {
      const question = button.textContent;
      const input = document.getElementById('messageInput');
      input.value = question;
      sendMessage();
    }

    // ===== THEME MANAGEMENT =====
    function initTheme() {
      const savedTheme = localStorage.getItem('arc_theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
      // Dark theme is default (no data-theme attribute = dark)
      // Only set light if user explicitly chose it or prefers light
      else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
        document.documentElement.setAttribute('data-theme', 'light');
      }
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      // If currently light, switch to dark (remove attribute); if dark/none, switch to light
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      if (newTheme === 'dark') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
      }
      localStorage.setItem('arc_theme', newTheme);
    }

    // ===== INPUT HANDLING =====
    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // ===== MESSAGE RENDERING =====
    function renderUserMessage(text) {
      return `
        <div class="message message-user">
          <div class="message-content">
            ${escapeHtml(text)}
          </div>
        </div>
      `;
    }

    function renderBotMessage(response) {
      const rawAnswer = response.answer || response.response || 'No response received.';
      const sources = response.sources || [];
      let confidence = response.confidence || null;
      
      // Try to extract confidence from answer text if not provided separately
      if (!confidence || !confidence.level) {
        const confidenceMatch = rawAnswer.match(/\*\*Confidence:\*\*\s*(High|Medium|Low)/i) ||
                                rawAnswer.match(/Confidence:\s*(High|Medium|Low)/i);
        if (confidenceMatch) {
          const level = confidenceMatch[1];
          const explanationMatch = rawAnswer.match(/Confidence:\s*(?:High|Medium|Low)\s*[â€”â€“-]\s*([^\n]+)/i);
          confidence = {
            level: level.charAt(0).toUpperCase() + level.slice(1).toLowerCase(),
            explanation: explanationMatch ? explanationMatch[1].trim() : ''
          };
        } else {
          confidence = { level: 'Unknown', explanation: '' };
        }
      }
      
      // Clean answer text - remove confidence section and section headers
      let cleanAnswer = rawAnswer
        .replace(/\*\*Confidence:\*\*[^\n]*/gi, '')
        .replace(/Confidence:\s*(?:High|Medium|Low)\s*[â€”â€“-][^\n]*/gi, '')
        .replace(/\*\*Short Answer:?\*\*\s*/gi, '')
        .replace(/\*\*Requirements:?\*\*\s*/gi, '')
        .replace(/\*\*Sources:?\*\*[\s\S]*$/gi, '') // Remove sources section from text
        .replace(/\*\*What to Submit:?\*\*\s*/gi, '')
        .replace(/\*\*Additional Notes:?\*\*\s*/gi, '')
        .trim();
      
      const confidenceClass = confidence.level ? confidence.level.toLowerCase() : 'unknown';
      const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substring(2, 7);
      
      // Build sources section with requirements
      let sourcesHtml = '';
      const validSources = sources.filter(s => s && (s.content || s.section_title || s.document_name));
      if (validSources.length > 0) {
        sourcesHtml = `
          <div class="sources-section">
            <div class="sources-title">Sources & Requirements</div>
            ${validSources.map((source, index) => renderSourceWithRequirements(source, index, messageId)).join('')}
          </div>
        `;
      }

      return `
        <div class="message message-bot" id="${messageId}">
          <div class="message-content">
            <div class="message-header">
              <div class="message-header-left">
                <span class="message-sender">ARC Bot</span>
              </div>
              <div class="message-header-right">
                <span class="confidence-badge confidence-${confidenceClass}" onclick="toggleConfidenceTooltip(this, event)" data-explanation="${escapeHtml(confidence.explanation || 'No additional details available.')}">
                  <span class="confidence-dot"></span>
                  ${escapeHtml(confidence.level || 'Unknown')}
                  <div class="confidence-tooltip">${escapeHtml(confidence.explanation || 'No additional details available.')}</div>
                </span>
                <button class="copy-btn" onclick="copyAnswer(this, '${messageId}')" title="Copy answer">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div class="answer-section">
              <div class="answer-label">Answer</div>
              <div class="answer-text" data-raw-answer="${escapeHtml(cleanAnswer)}">
                ${formatAnswerText(cleanAnswer)}
              </div>
            </div>
            ${sourcesHtml}
          </div>
        </div>
      `;
    }

    function renderSourceWithRequirements(source, index, messageId) {
      const hierarchy = source.section_hierarchy || [];
      const title = source.section_title || hierarchy[hierarchy.length - 1] || 'Unknown Section';
      const docName = source.document_name || 'Document';
      const content = source.content || 'Source content not available.';
      let requirements = source.requirements || [];
      const isBinding = source.is_binding !== false;
      
      // If no requirements provided, try intelligent extraction from content
      if (requirements.length === 0 && content) {
        requirements = extractRequirementsFromContent(content);
      }
      
      // Determine authority type based on document name
      const docNameLower = docName.toLowerCase();
      let authorityType, authorityLabel;

      if (docNameLower.includes('cc&r') || docNameLower.includes('ccr') || docNameLower.includes('declaration')) {
        authorityType = 'binding';
        authorityLabel = 'Binding';
      } else if (docNameLower.includes('city of bend') || docNameLower.includes('development code') || docNameLower.includes('bdc')) {
        authorityType = 'binding';
        authorityLabel = 'Binding';
      } else if (docNameLower.includes('design guideline') || docNameLower.includes('architectural')) {
        authorityType = 'guidance';
        authorityLabel = 'ARC Guidance';
      } else if (docNameLower.includes('rules') || docNameLower.includes('regulation')) {
        authorityType = 'guidance';
        authorityLabel = 'DWOA Guidance';
      } else {
        // Fallback based on is_binding flag
        authorityType = isBinding ? 'binding' : 'guidance';
        authorityLabel = isBinding ? 'Binding' : 'Guidance';
      }
      
      // Build full breadcrumb path: Document â€º Hierarchy â€º Section Title
      const pathParts = [docName];
      if (hierarchy.length > 0) {
        pathParts.push(...hierarchy);
      }
      if (title && !hierarchy.includes(title) && title !== docName) {
        pathParts.push(title);
      }
      const path = pathParts.join(' â€º ');
      
      const sourceId = `${messageId}-source-${index}`;
      
      // Build requirements list HTML with "Key Requirements" label
      let requirementsHtml = '';
      if (requirements.length > 0) {
        requirementsHtml = `
          <div class="source-requirements">
            <div class="requirements-label">Key Requirements</div>
            <ul>
              ${requirements.map(req => `<li>${escapeHtml(req)}</li>`).join('')}
            </ul>
          </div>
        `;
      }
      
      // Escape content and path for onclick attribute
      const escapedContent = content.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const escapedPath = path.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      
      return `
        <div class="source-item" id="${sourceId}">
          <div class="source-header">
            <div class="source-info">
              <div class="source-path">${escapeHtml(path)}</div>
              <div class="source-meta">
                <span class="authority-badge authority-${authorityType}">${authorityLabel}</span>
              </div>
            </div>
          </div>
          ${requirementsHtml}
          <button class="view-source-link" onclick="openSourceModal('${escapedPath}', '${escapedContent}')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            View source text
          </button>
        </div>
      `;
    }
    
    // Intelligent requirement extraction from content
    function extractRequirementsFromContent(content) {
      if (!content) return [];
      const requirements = [];
      
      // 1. Explicit bullets (-, â€¢, *, numbered)
      const bulletMatches = content.match(/^[\s]*[-â€¢*]\s+(.+)$/gm);
      if (bulletMatches) {
        bulletMatches.forEach(match => {
          const text = match.replace(/^[\s]*[-â€¢*]\s+/, '').trim();
          if (text.length > 15 && text.length < 200) {
            requirements.push(text);
          }
        });
      }
      
      const numberedMatches = content.match(/^[\s]*\d+[.)]\s+(.+)$/gm);
      if (numberedMatches) {
        numberedMatches.forEach(match => {
          const text = match.replace(/^[\s]*\d+[.)]\s+/, '').trim();
          if (text.length > 15 && text.length < 200) {
            requirements.push(text);
          }
        });
      }
      
      // 2. Measurement patterns (numbers with units)
      const measurementPattern = /[^.]*\b(\d+)\s*(feet|foot|ft|inches|inch|days?|percent|%|square feet|sq\.?\s*ft)[^.]*\./gi;
      const measurementMatches = content.match(measurementPattern);
      if (measurementMatches) {
        measurementMatches.forEach(match => {
          const text = match.trim();
          if (text.length > 15 && text.length < 200 && !requirements.includes(text)) {
            requirements.push(text);
          }
        });
      }
      
      // 3. Requirement keywords
      const keywordPattern = /[^.]*\b(must|shall|required|prohibited|not permitted|not allowed|maximum|minimum|limited to|cannot exceed|may not)[^.]*\./gi;
      const keywordMatches = content.match(keywordPattern);
      if (keywordMatches) {
        keywordMatches.forEach(match => {
          const text = match.trim();
          if (text.length > 15 && text.length < 200 && !requirements.includes(text)) {
            requirements.push(text);
          }
        });
      }
      
      // Dedupe and limit to 7
      const unique = [...new Set(requirements)];
      return unique.slice(0, 7);
    }

    function openSourceModal(title, content) {
      // Decode HTML entities
      const decodedContent = content.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
      
      const modal = document.getElementById('sourceModal');
      const modalTitle = document.getElementById('sourceModalTitle');
      const modalBody = document.getElementById('sourceModalBody');
      
      modalTitle.textContent = title;
      modalBody.textContent = decodedContent;
      modal.classList.add('active');
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }

    function closeSourceModal() {
      const modal = document.getElementById('sourceModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeSourceModal();
      }
    });

    function formatAnswerText(text) {
      if (!text) return '';
      
      let html = escapeHtml(text);
      
      // Bold: **text**
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      
      // Handle bullet lists first before line breaks
      const lines = html.split('\n');
      let inList = false;
      let result = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line.startsWith('- ')) {
          if (!inList) {
            result.push('<ul>');
            inList = true;
          }
          result.push(`<li>${line.substring(2)}</li>`);
        } else {
          if (inList) {
            result.push('</ul>');
            inList = false;
          }
          if (line) {
            result.push(`<p>${line}</p>`);
          }
        }
      }
      if (inList) {
        result.push('</ul>');
      }
      
      html = result.join('');
      
      // Clean up empty paragraphs
      html = html.replace(/<p><\/p>/g, '');
      
      return html || '<p>No answer available.</p>';
    }

    function toggleConfidenceTooltip(badge, event) {
      event.stopPropagation();
      
      // Close any other open tooltips
      document.querySelectorAll('.confidence-badge.tooltip-open').forEach(b => {
        if (b !== badge) {
          b.classList.remove('tooltip-open');
        }
      });
      
      badge.classList.toggle('tooltip-open');
    }

    // Close tooltip when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.confidence-badge')) {
        document.querySelectorAll('.confidence-badge.tooltip-open').forEach(badge => {
          badge.classList.remove('tooltip-open');
        });
      }
    });

    function copyAnswer(button, messageId) {
      const messageEl = document.getElementById(messageId);
      if (!messageEl) return;
      
      const answerEl = messageEl.querySelector('.answer-text');
      if (!answerEl) return;
      
      // Get the raw answer text from data attribute or innerText
      const rawAnswer = answerEl.getAttribute('data-raw-answer') || answerEl.innerText;
      
      navigator.clipboard.writeText(rawAnswer).then(() => {
        // Show success state
        button.classList.add('copied');
        button.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        `;
        
        // Reset after 2 seconds
        setTimeout(() => {
          button.classList.remove('copied');
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          `;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    // ===== TYPING INDICATOR WITH PROGRESS =====
    function getStageMessage(elapsedSeconds) {
      if (elapsedSeconds < 5) return 'Searching documents...';
      if (elapsedSeconds < 15) return 'Analyzing results...';
      if (elapsedSeconds < 30) return 'Generating response...';
      return 'Still working, please wait...';
    }

    function renderTypingIndicator(message = null, retryInfo = null) {
      const stageMessage = message || 'Searching documents...';
      const retryHtml = retryInfo ? `<div class="typing-retry">${retryInfo}</div>` : '';
      
      return `
        <div class="message message-bot" id="typingIndicator">
          <div class="typing-indicator">
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
            <div class="typing-status">
              <div class="typing-message">${escapeHtml(stageMessage)}</div>
              <div class="typing-time" id="typingTime">0s</div>
              ${retryHtml}
            </div>
          </div>
        </div>
      `;
    }

    function showTypingIndicator(message = null, retryInfo = null) {
      const chatArea = document.getElementById('chatArea');
      
      // Remove existing indicator if present
      const existing = document.getElementById('typingIndicator');
      if (existing) existing.remove();
      
      chatArea.insertAdjacentHTML('beforeend', renderTypingIndicator(message, retryInfo));
      scrollToBottom();
      
      // Start timer
      typingStartTime = Date.now();
      if (typingIntervalId) clearInterval(typingIntervalId);
      
      typingIntervalId = setInterval(() => {
        const elapsed = Math.floor((Date.now() - typingStartTime) / 1000);
        const timeEl = document.getElementById('typingTime');
        const messageEl = document.querySelector('#typingIndicator .typing-message');
        
        if (timeEl) timeEl.textContent = `${elapsed}s`;
        if (messageEl && !retryInfo) messageEl.textContent = getStageMessage(elapsed);
      }, 1000);
    }

    function updateTypingIndicator(message, retryInfo = null) {
      const indicator = document.getElementById('typingIndicator');
      if (!indicator) return;
      
      const messageEl = indicator.querySelector('.typing-message');
      if (messageEl) messageEl.textContent = message;
      
      // Add or update retry info
      const statusEl = indicator.querySelector('.typing-status');
      let retryEl = indicator.querySelector('.typing-retry');
      
      if (retryInfo && statusEl) {
        if (retryEl) {
          retryEl.textContent = retryInfo;
        } else {
          statusEl.insertAdjacentHTML('beforeend', `<div class="typing-retry">${escapeHtml(retryInfo)}</div>`);
        }
      } else if (retryEl) {
        retryEl.remove();
      }
    }

    function hideTypingIndicator() {
      if (typingIntervalId) {
        clearInterval(typingIntervalId);
        typingIntervalId = null;
      }
      typingStartTime = null;
      
      const indicator = document.getElementById('typingIndicator');
      if (indicator) indicator.remove();
    }

    // ===== ERROR CLASSIFICATION =====
    const ErrorTypes = {
      NETWORK: 'network',
      TIMEOUT: 'timeout',
      CANCELLED: 'cancelled',
      SERVER: 'server',
      RATE_LIMITED: 'rate_limited',
      BAD_RESPONSE: 'bad_response',
      UNKNOWN: 'unknown'
    };

    function classifyError(error, response = null) {
      // User cancelled
      if (wasCancelled) {
        return ErrorTypes.CANCELLED;
      }
      
      // Abort errors (timeout or cancel)
      if (error.name === 'AbortError') {
        return ErrorTypes.TIMEOUT;
      }
      
      // Network errors
      if (error instanceof TypeError || !navigator.onLine) {
        return ErrorTypes.NETWORK;
      }
      
      // HTTP status-based errors
      if (response) {
        if (response.status === 429) return ErrorTypes.RATE_LIMITED;
        if (response.status >= 500) return ErrorTypes.SERVER;
      }
      
      // Check error message for clues
      if (error.message && error.message.includes('JSON')) {
        return ErrorTypes.BAD_RESPONSE;
      }
      
      return ErrorTypes.UNKNOWN;
    }

    function getErrorDetails(errorType, elapsedTime = null) {
      const details = {
        [ErrorTypes.NETWORK]: {
          title: 'Connection failed',
          message: 'Unable to reach the server. Please check your internet connection.',
          icon: 'wifi-off',
          canRetry: true
        },
        [ErrorTypes.TIMEOUT]: {
          title: 'Request timed out',
          message: `The server took too long to respond${elapsedTime ? ` (${elapsedTime}s)` : ''}. It may be busy.`,
          icon: 'clock',
          canRetry: true
        },
        [ErrorTypes.CANCELLED]: {
          title: 'Request cancelled',
          message: 'You cancelled the request.',
          icon: 'x-circle',
          canRetry: false
        },
        [ErrorTypes.SERVER]: {
          title: 'Server error',
          message: 'The server encountered an error. Please try again in a moment.',
          icon: 'server',
          canRetry: true
        },
        [ErrorTypes.RATE_LIMITED]: {
          title: 'Too many requests',
          message: 'Please wait a moment before sending another message.',
          icon: 'alert-triangle',
          canRetry: false
        },
        [ErrorTypes.BAD_RESPONSE]: {
          title: 'Invalid response',
          message: 'Received an unexpected response from the server.',
          icon: 'alert-circle',
          canRetry: true
        },
        [ErrorTypes.UNKNOWN]: {
          title: 'Something went wrong',
          message: 'An unexpected error occurred. Please try again.',
          icon: 'alert-circle',
          canRetry: true
        }
      };
      
      return details[errorType] || details[ErrorTypes.UNKNOWN];
    }

    function getErrorIcon(iconName) {
      const icons = {
        'wifi-off': '<path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39M10.71 5.05A16 16 0 0 1 22.58 9M1.42 9a15.91 15.91 0 0 1 4.7-2.88M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"></path>',
        'clock': '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>',
        'x-circle': '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>',
        'server': '<rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line>',
        'alert-triangle': '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>',
        'alert-circle': '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'
      };
      return icons[iconName] || icons['alert-circle'];
    }

    function renderError(errorType, elapsedTime = null) {
      const details = getErrorDetails(errorType, elapsedTime);
      const iconPath = getErrorIcon(details.icon);
      
      const retryButton = details.canRetry && lastMessageForRetry ? `
        <div class="error-actions">
          <button class="error-retry-btn" onclick="retryLastMessage()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Try again
          </button>
        </div>
      ` : '';
      
      return `
        <div class="message message-bot">
          <div class="error-message">
            <div class="error-message-content">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                ${iconPath}
              </svg>
              <div class="error-message-text">
                <div class="error-message-title">${escapeHtml(details.title)}</div>
                <div class="error-message-detail">${escapeHtml(details.message)}</div>
              </div>
            </div>
            ${retryButton}
          </div>
        </div>
      `;
    }

    function retryLastMessage() {
      if (lastMessageForRetry && !isLoading) {
        const input = document.getElementById('messageInput');
        input.value = lastMessageForRetry;
        sendMessage();
      }
    }

    // ===== UTILITIES =====
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatMarkdown(text) {
      if (!text) return '';
      
      // Basic markdown formatting
      let html = escapeHtml(text);
      
      // Bold: **text**
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      
      // Line breaks
      html = html.replace(/\n\n/g, '</p><p>');
      html = html.replace(/\n/g, '<br>');
      
      // Bullet lists: - item
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
      // Clean up multiple ul tags
      html = html.replace(/<\/ul>\s*<ul>/g, '');
      
      // Numbered lists: 1. item
      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
      
      // Wrap in paragraph if not already structured
      if (!html.startsWith('<')) {
        html = '<p>' + html + '</p>';
      }
      
      return html;
    }

    function scrollToBottom() {
      const chatArea = document.getElementById('chatArea');
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // ===== SEND BUTTON MANAGEMENT =====
    function setSendButtonMode(mode) {
      const sendBtn = document.getElementById('sendBtn');
      if (!sendBtn) return;
      
      if (mode === 'cancel') {
        sendBtn.classList.add('cancel-mode');
        sendBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        `;
        sendBtn.title = 'Cancel request';
        sendBtn.onclick = cancelCurrentRequest;
        sendBtn.disabled = false;
      } else {
        sendBtn.classList.remove('cancel-mode');
        sendBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        `;
        sendBtn.title = 'Send message';
        sendBtn.onclick = sendMessage;
      }
    }

    function resetSendButton() {
      const sendBtn = document.getElementById('sendBtn');
      const input = document.getElementById('messageInput');
      
      setSendButtonMode('send');
      if (sendBtn) sendBtn.disabled = false;
      if (input) input.disabled = false;
    }

    function cancelCurrentRequest() {
      if (currentAbortController) {
        wasCancelled = true;
        currentAbortController.abort();
      }
    }

    // ===== RETRY LOGIC =====
    function isRetryableError(errorType) {
      return [
        ErrorTypes.NETWORK,
        ErrorTypes.TIMEOUT,
        ErrorTypes.SERVER
      ].includes(errorType);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function sendMessageAttempt(message, signal) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: message,
          session_id: getSessionId()
        }),
        signal: signal
      });
      
      // Store response for error classification
      if (!response.ok) {
        const error = new Error(`HTTP error! status: ${response.status}`);
        error.response = response;
        throw error;
      }
      
      const data = await response.json();
      return data;
    }

    async function sendMessageWithRetry(message, signal) {
      let lastError;
      let lastErrorType = ErrorTypes.UNKNOWN;
      
      for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
        try {
          // Reset cancelled flag at start of each attempt
          if (attempt === 1) wasCancelled = false;
          
          return await sendMessageAttempt(message, signal);
        } catch (error) {
          lastError = error;
          lastErrorType = classifyError(error, error.response);
          
          // Don't retry if cancelled or not retryable
          if (wasCancelled || !isRetryableError(lastErrorType)) {
            throw error;
          }
          
          // Don't retry on last attempt
          if (attempt === MAX_RETRIES) {
            throw error;
          }
          
          // Calculate delay with exponential backoff
          const delay = Math.pow(2, attempt - 1) * RETRY_DELAY_BASE_MS;
          
          // Update UI for retry
          updateTypingIndicator(
            `Retrying...`,
            `Attempt ${attempt + 1} of ${MAX_RETRIES} in ${delay / 1000}s`
          );
          
          await sleep(delay);
          
          // Update message after delay
          updateTypingIndicator('Searching documents...', `Attempt ${attempt + 1} of ${MAX_RETRIES}`);
        }
      }
      
      throw lastError;
    }

    // ===== API COMMUNICATION =====
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (!message || isLoading) return;
      
      // Store for potential retry
      lastMessageForRetry = message;
      wasCancelled = false;
      
      // Clear input
      input.value = '';
      autoResize(input);
      
      // Remove welcome panel if present
      const welcomePanel = document.querySelector('.welcome-panel');
      if (welcomePanel) {
        welcomePanel.remove();
      }
      
      // Add user message to UI
      const chatArea = document.getElementById('chatArea');
      chatArea.insertAdjacentHTML('beforeend', renderUserMessage(message));
      
      // Show typing indicator with progress
      showTypingIndicator();
      
      // Set up abort controller with timeout
      currentAbortController = new AbortController();
      const timeoutId = setTimeout(() => {
        if (currentAbortController) {
          currentAbortController.abort();
        }
      }, REQUEST_TIMEOUT_MS);
      
      // Switch to cancel mode
      isLoading = true;
      input.disabled = true;
      setSendButtonMode('cancel');
      
      let elapsedTime = null;
      
      try {
        const data = await sendMessageWithRetry(message, currentAbortController.signal);
        
        // Calculate elapsed time
        if (typingStartTime) {
          elapsedTime = Math.floor((Date.now() - typingStartTime) / 1000);
        }
        
        // Remove typing indicator
        hideTypingIndicator();
        
        // Add bot response
        chatArea.insertAdjacentHTML('beforeend', renderBotMessage(data));
        
        // Store message
        messages.push({ role: 'user', content: message });
        messages.push({ role: 'assistant', content: data });
        
        // Clear retry message on success
        lastMessageForRetry = null;
        
      } catch (error) {
        console.error('Error sending message:', error);
        
        // Calculate elapsed time for error message
        if (typingStartTime) {
          elapsedTime = Math.floor((Date.now() - typingStartTime) / 1000);
        }
        
        // Remove typing indicator
        hideTypingIndicator();
        
        // Classify and show appropriate error
        const errorType = classifyError(error, error.response);
        
        // Don't show error message if user cancelled
        if (errorType !== ErrorTypes.CANCELLED) {
          chatArea.insertAdjacentHTML('beforeend', renderError(errorType, elapsedTime));
        }
      } finally {
        // Clear timeout
        clearTimeout(timeoutId);
        currentAbortController = null;
        
        // Re-enable input
        isLoading = false;
        resetSendButton();
        input.disabled = false;
        input.focus();
      }
      
      scrollToBottom();
    }

    // ===== VOICE MODE =====
    const VOICE_API_URL = 'https://n8n.srv1208741.hstgr.cloud/webhook/arc-voice-session';
    
    // Voice state
    let voiceState = 'idle'; // idle, connecting, listening, processing, speaking
    let peerConnection = null;
    let dataChannel = null;
    let localStream = null;
    let voiceSessionActive = false;
    
    function openVoiceMode() {
      const overlay = document.getElementById('voiceOverlay');
      if (overlay) {
        overlay.classList.add('active');
        setVoiceState('idle');
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeVoiceMode() {
      const overlay = document.getElementById('voiceOverlay');
      if (overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      // Clean up voice session
      stopVoiceCapture();
      cleanupVoiceSession();
    }
    
    function setVoiceState(state) {
      voiceState = state;
      const overlay = document.getElementById('voiceOverlay');
      const statusText = document.getElementById('voiceStatusText');
      const startBtn = document.getElementById('voiceStartBtn');
      const stopBtn = document.getElementById('voiceStopBtn');
      
      if (overlay) {
        overlay.setAttribute('data-state', state);
      }
      
      // Update status text
      const statusMessages = {
        idle: 'Tap to start speaking',
        connecting: 'Connecting...',
        listening: 'Listening...',
        processing: 'Thinking...',
        speaking: 'Speaking...'
      };
      
      if (statusText) {
        statusText.textContent = statusMessages[state] || 'Ready';
      }
      
      // Update button visibility
      if (startBtn && stopBtn) {
        if (state === 'idle') {
          startBtn.style.display = 'flex';
          stopBtn.style.display = 'none';
        } else {
          startBtn.style.display = 'none';
          stopBtn.style.display = 'flex';
        }
      }
    }
    
    function showVoiceError(message) {
      const errorEl = document.getElementById('voiceError');
      const errorText = document.getElementById('voiceErrorText');
      
      if (errorEl && errorText) {
        errorText.textContent = message;
        errorEl.classList.add('visible');
        
        // Hide after 5 seconds
        setTimeout(() => {
          errorEl.classList.remove('visible');
        }, 5000);
      }
    }
    
    function updateVoiceTranscript(userText, botText) {
      const userEl = document.getElementById('voiceTranscriptUser');
      const botEl = document.getElementById('voiceTranscriptBot');
      
      if (userEl && userText !== undefined) {
        userEl.textContent = userText ? `"${userText}"` : '';
      }
      
      if (botEl && botText !== undefined) {
        botEl.textContent = botText || '';
      }
    }
    
    async function startVoiceCapture() {
      try {
        // Request microphone permission
        setVoiceState('connecting');
        updateVoiceTranscript('', '');
        
        // Check if microphone is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Microphone not supported in this browser');
        }
        
        // Get ephemeral token from backend
        const tokenResponse = await fetch(VOICE_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: getSessionId() })
        });
        
        if (!tokenResponse.ok) {
          throw new Error('Failed to get voice session token');
        }
        
        const tokenData = await tokenResponse.json();
        
        if (!tokenData.client_secret || !tokenData.client_secret.value) {
          throw new Error('Invalid token response from server');
        }
        
        // Initialize WebRTC connection
        await initializeVoiceSession(tokenData.client_secret.value);
        
      } catch (error) {
        console.error('[Voice] Error starting capture:', error);
        setVoiceState('idle');
        
        if (error.name === 'NotAllowedError') {
          showVoiceError('Microphone permission denied. Please allow microphone access.');
        } else if (error.name === 'NotFoundError') {
          showVoiceError('No microphone found. Please connect a microphone.');
        } else {
          showVoiceError(error.message || 'Failed to start voice mode');
        }
      }
    }
    
    async function initializeVoiceSession(ephemeralKey) {
      // Create peer connection
      peerConnection = new RTCPeerConnection();
      
      // Set up audio output
      const audioEl = document.getElementById('voiceAudio');
      peerConnection.ontrack = (event) => {
        if (audioEl) {
          audioEl.srcObject = event.streams[0];
          audioEl.play().catch(e => console.error('[Voice] Audio play error:', e));
        }
      };
      
      // Get microphone stream
      localStream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        } 
      });
      
      // Add audio track to peer connection
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
      
      // Create data channel for events
      dataChannel = peerConnection.createDataChannel('oai-events');
      dataChannel.onopen = () => {
        console.log('[Voice] Data channel opened');
        voiceSessionActive = true;
        configureVoiceSession();
      };
      
      dataChannel.onmessage = handleVoiceEvent;
      
      dataChannel.onclose = () => {
        console.log('[Voice] Data channel closed');
        voiceSessionActive = false;
      };
      
      // Create and set local description
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      
      // Connect to OpenAI Realtime API
      const baseUrl = 'https://api.openai.com/v1/realtime';
      const model = 'gpt-4o-realtime-preview-2024-12-17';
      
      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ephemeralKey}`,
          'Content-Type': 'application/sdp'
        },
        body: offer.sdp
      });
      
      if (!sdpResponse.ok) {
        throw new Error('Failed to connect to OpenAI Realtime API');
      }
      
      const answerSdp = await sdpResponse.text();
      await peerConnection.setRemoteDescription({
        type: 'answer',
        sdp: answerSdp
      });
      
      setVoiceState('listening');
    }
    
    function configureVoiceSession() {
      if (!dataChannel || dataChannel.readyState !== 'open') return;
      
      // Configure session with system prompt and tools
      const sessionConfig = {
        type: 'session.update',
        session: {
          modalities: ['text', 'audio'],
          instructions: `You are ARC Bot, an AI assistant for the Discovery West community in Bend, Oregon. You help residents and ARC committee members understand architectural guidelines, CC&Rs, and community rules.

IMPORTANT RULES:
1. Only answer questions about Discovery West architectural guidelines, CC&Rs, rules, and related topics.
2. If you need to search documents, use the search_documents function.
3. Always cite your sources when providing information from documents.
4. If you don't know something or can't find it in the documents, say so clearly.
5. Be concise but thorough in voice responses.
6. Speak naturally and conversationally.

You have access to official Discovery West documents including:
- ARC Design Guidelines
- CC&Rs (Covenants, Conditions & Restrictions)
- Rules & Regulations
- City of Bend Development Code (Overlay Zone)`,
          voice: 'alloy',
          input_audio_transcription: {
            model: 'whisper-1'
          },
          turn_detection: {
            type: 'server_vad',
            threshold: 0.5,
            prefix_padding_ms: 300,
            silence_duration_ms: 500
          },
          tools: [
            {
              type: 'function',
              name: 'search_documents',
              description: 'Search Discovery West official documents for relevant information about architectural guidelines, CC&Rs, rules, and regulations.',
              parameters: {
                type: 'object',
                properties: {
                  query: {
                    type: 'string',
                    description: 'The search query to find relevant document sections'
                  }
                },
                required: ['query']
              }
            }
          ]
        }
      };
      
      dataChannel.send(JSON.stringify(sessionConfig));
    }
    
    async function handleVoiceEvent(event) {
      try {
        const data = JSON.parse(event.data);
        console.log('[Voice] Event:', data.type);
        
        switch (data.type) {
          case 'session.created':
          case 'session.updated':
            console.log('[Voice] Session configured');
            break;
            
          case 'input_audio_buffer.speech_started':
            setVoiceState('listening');
            break;
            
          case 'input_audio_buffer.speech_stopped':
            setVoiceState('processing');
            break;
            
          case 'conversation.item.input_audio_transcription.completed':
            if (data.transcript) {
              updateVoiceTranscript(data.transcript, undefined);
            }
            break;
            
          case 'response.function_call_arguments.done':
            // Handle function call (RAG search)
            if (data.name === 'search_documents') {
              await handleDocumentSearch(data.call_id, data.arguments);
            }
            break;
            
          case 'response.audio_transcript.delta':
            // Update bot transcript as it's being generated
            const currentBot = document.getElementById('voiceTranscriptBot')?.textContent || '';
            updateVoiceTranscript(undefined, currentBot + (data.delta || ''));
            break;
            
          case 'response.audio.started':
            setVoiceState('speaking');
            break;
            
          case 'response.audio.done':
          case 'response.done':
            setVoiceState('listening');
            break;
            
          case 'error':
            console.error('[Voice] API Error:', data.error);
            showVoiceError(data.error?.message || 'An error occurred');
            setVoiceState('idle');
            break;
        }
      } catch (e) {
        console.error('[Voice] Error handling event:', e);
      }
    }
    
    async function handleDocumentSearch(callId, argsString) {
      try {
        const args = JSON.parse(argsString);
        const query = args.query;
        
        console.log('[Voice] Searching documents for:', query);
        
        // Call the existing RAG endpoint
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: query,
            session_id: getSessionId()
          })
        });
        
        let searchResults = '';
        
        if (response.ok) {
          const data = await response.json();
          // Format results for the voice model
          if (data.sources && data.sources.length > 0) {
            searchResults = data.sources.map(s => 
              `[${s.document}${s.section ? ' - ' + s.section : ''}]: ${s.text || s.preview || ''}`
            ).join('\n\n');
          }
          if (data.answer) {
            searchResults = `Answer found: ${data.answer}\n\nSources:\n${searchResults}`;
          }
        }
        
        if (!searchResults) {
          searchResults = 'No relevant documents found for this query.';
        }
        
        // Send function result back to the model
        const functionResult = {
          type: 'conversation.item.create',
          item: {
            type: 'function_call_output',
            call_id: callId,
            output: searchResults
          }
        };
        
        if (dataChannel && dataChannel.readyState === 'open') {
          dataChannel.send(JSON.stringify(functionResult));
          
          // Trigger response generation
          dataChannel.send(JSON.stringify({ type: 'response.create' }));
        }
        
      } catch (error) {
        console.error('[Voice] Document search error:', error);
        
        // Send error result
        if (dataChannel && dataChannel.readyState === 'open') {
          dataChannel.send(JSON.stringify({
            type: 'conversation.item.create',
            item: {
              type: 'function_call_output',
              call_id: callId,
              output: 'Error searching documents. Please try again.'
            }
          }));
          dataChannel.send(JSON.stringify({ type: 'response.create' }));
        }
      }
    }
    
    function stopVoiceCapture() {
      setVoiceState('idle');
      
      // Send end of input if session is active
      if (dataChannel && dataChannel.readyState === 'open') {
        try {
          dataChannel.send(JSON.stringify({ type: 'input_audio_buffer.commit' }));
        } catch (e) {
          console.error('[Voice] Error committing audio:', e);
        }
      }
    }
    
    function cleanupVoiceSession() {
      voiceSessionActive = false;
      
      // Close data channel
      if (dataChannel) {
        dataChannel.close();
        dataChannel = null;
      }
      
      // Close peer connection
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      
      // Stop local media stream
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      // Clear transcripts
      updateVoiceTranscript('', '');
    }

    // ===== INITIALIZATION =====
    // ===== PWA: SERVICE WORKER REGISTRATION =====
    let deferredInstallPrompt = null;
    let isAppInstalled = false;
    
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('./sw.js');
          console.log('[PWA] Service worker registered:', registration.scope);
          
          // Handle updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New content available, could prompt user to refresh
                console.log('[PWA] New version available');
              }
            });
          });
        } catch (error) {
          console.error('[PWA] Service worker registration failed:', error);
        }
      }
    }
    
    // ===== PWA: INSTALL PROMPT HANDLING =====
    function setupInstallPrompt() {
      // Check if already installed
      if (window.matchMedia('(display-mode: standalone)').matches) {
        isAppInstalled = true;
        hideInstallBanner();
        return;
      }
      
      // Listen for beforeinstallprompt (Android/Desktop)
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        showInstallBanner('android');
      });
      
      // Detect iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS && !isAppInstalled && !localStorage.getItem('arc-install-dismissed')) {
        // Show iOS install instructions after a delay
        setTimeout(() => showInstallBanner('ios'), 3000);
      }
      
      // Listen for successful install
      window.addEventListener('appinstalled', () => {
        isAppInstalled = true;
        deferredInstallPrompt = null;
        hideInstallBanner();
        console.log('[PWA] App installed successfully');
      });
    }
    
    function showInstallBanner(platform) {
      // Don't show if already dismissed this session
      if (localStorage.getItem('arc-install-dismissed')) return;
      
      const banner = document.getElementById('installBanner');
      const iosInstructions = document.getElementById('iosInstructions');
      const androidButton = document.getElementById('androidInstallBtn');
      
      if (banner) {
        if (platform === 'ios') {
          iosInstructions.style.display = 'block';
          androidButton.style.display = 'none';
        } else {
          iosInstructions.style.display = 'none';
          androidButton.style.display = 'flex';
        }
        banner.classList.add('visible');
      }
    }
    
    function hideInstallBanner() {
      const banner = document.getElementById('installBanner');
      if (banner) {
        banner.classList.remove('visible');
      }
    }
    
    function dismissInstallBanner() {
      hideInstallBanner();
      localStorage.setItem('arc-install-dismissed', 'true');
    }
    
    async function promptInstall() {
      if (!deferredInstallPrompt) return;
      
      deferredInstallPrompt.prompt();
      const { outcome } = await deferredInstallPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('[PWA] User accepted install prompt');
      } else {
        console.log('[PWA] User dismissed install prompt');
      }
      
      deferredInstallPrompt = null;
      hideInstallBanner();
    }
    
    // ===== PWA: OFFLINE DETECTION =====
    let isOnline = navigator.onLine;
    
    function updateOnlineStatus() {
      const wasOnline = isOnline;
      isOnline = navigator.onLine;
      
      const banner = document.getElementById('offlineBanner');
      if (banner) {
        if (!isOnline) {
          banner.classList.add('visible');
        } else {
          banner.classList.remove('visible');
          // Show brief "back online" message
          if (!wasOnline) {
            banner.textContent = 'âœ“ Back online';
            banner.classList.add('visible', 'online');
            setTimeout(() => {
              banner.classList.remove('visible', 'online');
              banner.textContent = 'You\'re offline â€” cached content only';
            }, 2000);
          }
        }
      }
    }
    
    function setupOfflineDetection() {
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      // Initial check
      updateOnlineStatus();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      getSessionId();
      
      // Render welcome panel (single source of truth)
      const chatArea = document.getElementById('chatArea');
      if (chatArea) {
        chatArea.innerHTML = generateWelcomePanel();
      }
      
      // Focus input
      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        messageInput.focus();
      }
      
      // PWA initialization
      registerServiceWorker();
      setupInstallPrompt();
      setupOfflineDetection();
    });
  </script>

  <!-- Source Text Modal -->
  <div class="source-modal-overlay" id="sourceModal" onclick="if(event.target === this) closeSourceModal()">
    <div class="source-modal">
      <div class="source-modal-header">
        <div class="source-modal-title" id="sourceModalTitle"></div>
        <button class="source-modal-close" onclick="closeSourceModal()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="source-modal-body" id="sourceModalBody"></div>
    </div>
  </div>

  <!-- Voice Mode Overlay -->
  <div class="voice-overlay" id="voiceOverlay" data-state="idle">
    <button class="voice-close" onclick="closeVoiceMode()" aria-label="Close voice mode">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    
    <div class="voice-content">
      <!-- Animated Orb -->
      <div class="voice-orb-container">
        <div class="voice-orb">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </div>
        <div class="voice-orb-ring"></div>
        <div class="voice-orb-ring"></div>
        <div class="voice-orb-ring"></div>
      </div>
      
      <!-- Transcript Area -->
      <div class="voice-transcript">
        <div class="voice-transcript-user" id="voiceTranscriptUser"></div>
        <div class="voice-transcript-bot" id="voiceTranscriptBot"></div>
      </div>
      
      <!-- Status -->
      <div class="voice-status">
        <div class="voice-status-dot"></div>
        <span id="voiceStatusText">Tap to start speaking</span>
      </div>
      
      <!-- Error Display -->
      <div class="voice-error" id="voiceError">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <span id="voiceErrorText"></span>
      </div>
      
      <!-- Action Buttons -->
      <div class="voice-actions" id="voiceActions">
        <button class="voice-action-btn primary" id="voiceStartBtn" onclick="startVoiceCapture()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          </svg>
          Start talking
        </button>
        <button class="voice-action-btn stop" id="voiceStopBtn" onclick="stopVoiceCapture()" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
          </svg>
          Stop
        </button>
      </div>
    </div>
    
    <!-- Hidden audio element for playback -->
    <audio id="voiceAudio" style="display: none;"></audio>
  </div>
</body>
</html>